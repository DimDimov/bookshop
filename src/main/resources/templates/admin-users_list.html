<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<link rel="shortcut icon" th:href="@{/images/favicon.ico}">
<head>
    <meta charset="UTF-8">
    <title>die Liste der Benutzer</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/admin_users_list.css}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel ="stylesheet">-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
<div class="users-page">
    <h2>die Liste der Benutzer</h2>
<div class="home-btn">
    <a class="linkToStartPage" th:href="@{'/home'}">Zu die Startseite</a>
</div>

<table class="user-table">
    <thead>
    <th class="number">Nummer</th>
    <th class="firstName">Vorname</th>
    <th class="secondName">Nachname</th>
    <th class="birthday">Geburtstag</th>
    <th class="country">Staat</th>
    <th class="town">Stadt</th>
    <th class="street">Strasse</th>
    <th class="houseNumber">Hausnummer</th>
    <th class="index">Postzahl</th>
    <th class="email">Email</th>
    <th class="role">Role</th>
    <th class="status">Status</th>
    <th class="disable">Aktivieren/Deaktivieren</th>
    </thead>
    <tbody>
    <tr th:each="user, iterStat : ${users}">
        <td th:text="${iterStat.count}"></td>
        <td th:text="${user.getFirstName()}"></td>
        <td th:text="${user.getLastName()}"></td>
        <td th:text="${user.getBirthday()}"></td>
        <td th:text="${user.getCountry()}"></td>
        <td th:text="${user.getTown()}"></td>
        <td th:text="${user.getStreet()}"></td>
        <td th:text="${user.getHouseNumber()}"></td>
        <td th:text="${user.getPostcode()}"></td>
        <td th:text="${user.email}"></td>
        <td>
            <span th:each="role : ${user.roles}"
                  th:text="${role.name == 'ROLE_ADMIN' ? 'Admin' : (role.name == 'ROLE_USER' ? 'User' : role.name)}"></span>
        </td>
        <td th:id="'user-status-' + ${user.id}">
            <span th:text="${user.enabled} ? 'Aktivieren' : 'Deaktivieren'"></span>
        </td>
        <td>
            <label th:id="'checkbox-label-' + ${user.id}" class="custom-checkbox">
                <input type="checkbox"
                       th:checked="${user.enabled}"
                       th:data-user-id="${user.id}"
                       th:id="'custom-checkbox-' + ${user.id}"
                       th:onchange="'toggleUserStatus(' + ${user.id} + ', this)'"
                       class="switch-enabled">
                <i class="fas fa-check"></i>
            </label>
        </td>
    </tr>
    </tbody>
</table>
</div>
<script>

    function updateCheckbox(userId) {
        const checkbox = document.querySelector('#custom-checkbox-' + userId);
        const enabled = checkbox.checked;
        const label = document.getElementById('checkbox-label-' + userId);
        const icon = label.querySelector('i');
        if (enabled) {
            icon.className = 'fas fa-check';
            label.classList.remove('disabled');
            label.classList.add('enabled');
        } else {
            label.classList.remove('enabled');
            label.classList.add('disabled');
            icon.className = 'fas fa-times';
        }
    }

    function toggleUserStatus(userId, checkbox) {

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        /*   const userId = this.getAttribute("data-user-id");*/
        const enabled = checkbox.checked;
        const statusCell = document.getElementById('user-status-' + userId);

        fetch(`/admin/users/${userId}/enabled`, {
            method: "POST",
            headers: {
                [csrfHeader]: csrfToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({enabled: enabled})
        }).then(response => {

            if (response.ok) {
                statusCell.textContent = enabled ? 'Aktivieren' : 'Deaktivieren';

            }
            if (!response.ok) alert("Fehler");
            updateCheckbox(userId);
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.custom-checkbox input[type="checkbox"]').forEach(function (checkbox) {

            const userId = checkbox.getAttribute('data-user-id');
            updateCheckbox(userId);
        });
    });


</script>


</body>
</html>